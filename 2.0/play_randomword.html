<!DOCTYPE html>
<html>
<head>
   <title>Cows & Bulls</title>
   	<meta name="viewport" content="width=device-width, initial-scale=1">
   	<link rel="stylesheet" href="js/jquery.mobile-1.3.2.min.css">
	<script src="js/jquery-1.8.3.min.js"></script>
	<script src="js/jquery.mobile-1.3.2.min.js"></script>
	<script src="js/wordizy_common.js"></script>
</head>
<body>

<div data-role="page" id="pageone">

	<div data-role="header" data-position="fixed">
		<div data-role="controlgroup" data-type="horizontal" data-mini="true" class="ui-btn-left">
			<input type = "button" id="words_quited" data-icon="delete" data-iconpos="left" value= "0">
			<input type = "button" id="words_played" data-icon="check" data-iconpos="left" value= "0">
		</div>
		<input type = "button" id="total_points" value= "Points: " class="ui-btn-right">
		<h1>Wordizy</h1>
	</div><!-- /header -->

	<div data-role="content" id="content_id" align="center">
			<div id="hint_content_div" align="center" style='overflow:auto;height:100px'>
			</div>
			<div id="button_groups">
				<div id="randomword_placeholder" data-role="controlgroup" data-type="horizontal"></div>

				<div data-role="controlgroup" data-type="horizontal" data-mini="true">
					<input type="button" id="delete_characters" data-icon="refresh" data-iconpos="notext" onclick="on_delete_clicked(event)">
					<input type="button" id="display_hint" data-icon="info" data-iconpos="notext" onclick="on_hint_clicked(event)">
					<input type="button" id="reveal_star" data-icon="search" data-iconpos="notext" onclick="on_star_clicked(event)">
				</div>

				<div id="key_board1" data-role="controlgroup" data-type="horizontal">
						  <input type = "button" id="key_0" data-mini="true" value= "#" onclick="on_key_clicked(event)">
						  <input type = "button" id="key_1" data-mini="true" value= "#" onclick="on_key_clicked(event)">
						  <input type = "button" id="key_2" data-mini="true" value= "#" onclick="on_key_clicked(event)">
						  <input type = "button" id="key_3" data-mini="true" value= "#" onclick="on_key_clicked(event)">
						  <input type = "button" id="key_4" data-mini="true" value= "#" onclick="on_key_clicked(event)">
						  <input type = "button" id="key_5" data-mini="true" value= "#" onclick="on_key_clicked(event)">
				</div>
				<div id="key_board2" data-role="controlgroup" data-type="horizontal">
						  <input type = "button" id="key_6" data-mini="true" value= "#" onclick="on_key_clicked(event)">
						  <input type = "button" id="key_7" data-mini="true" value= "#" onclick="on_key_clicked(event)">
						  <input type = "button" id="key_8" data-mini="true" value= "#" onclick="on_key_clicked(event)">
						  <input type = "button" id="key_9" data-mini="true" value= "#" onclick="on_key_clicked(event)">
						  <input type = "button" id="key_10" data-mini="true" value= "#" onclick="on_key_clicked(event)">
						  <input type = "button" id="key_11" data-mini="true" value= "#" onclick="on_key_clicked(event)">
				</div>
	  		</div>
    </div><!-- /content -->

	<div data-role="footer" data-position="fixed" align="center">
		<a href="quit.html" id="giveup_word" data-ajax="false" data-transition="flip" data-theme="d"  data-role="button" class="ui-btn-left">Give Up!</a>
		<h4>Wordizy</h4>
		<a href="google.com" data-icon="star" data-iconpos="right" data-theme="d" data-role="button" class="ui-btn-right">Like</a>
	</div><!-- /footer -->

</div><!-- /page -->
    <script>

		reveal_clicked = 0;
		hint_clicked = 0;

	var storedData = localStorage["wordizy"];
		if(storedData)
		{
			var savedGameInfo = JSON.parse(storedData);

			MAX_HINT_ALLOWED = savedGameInfo.max_hint_allowed ;
			MAX_REVEAL_ALLOWED = savedGameInfo.max_reveal_allowed;
			TOTAL_POINTS = savedGameInfo.total_points ;
			PLAYED_COUNT = savedGameInfo.played_count ;
			QUIT_COUNT = savedGameInfo.quit_count ;
			user_word = gasavedGameInfomeInfo.last_user_word ;
			to_key_from_key_map = savedGameInfo.to_key_from_key_map ;
			random_word_object = savedGameInfo.last_word_object ;
			user_input_array = savedGameInfo.user_input_array;
		}
		else
		{
			var random_number = getRandomNum(1, true);
			while(random_number < MIN_WORD_SIZE)
			{
				random_number = getRandomNum(1, true);
			}
			getRandomWordRawData(random_number, random_number);
			user_input_array = getContainerHTML(random_number, "randomword_placeholder");
		}


		function fillKeyBoard()
		{
			var temp_key_map = {};
			for(i = 0; i <= MAX_KEY_BOARD_INDEX;)
			{
				var rand_number_lessthan26 = Math.floor(Math.random() * 26 + 1);
				if(!temp_key_map[rand_number_lessthan26] && rand_number_lessthan26 < 26)
				{
					var keyid = "#key_" + i;
					temp_key_map[rand_number_lessthan26] = keyid;
					var rand_number_lessthan26_text = "" + ENGLISH_LETTER[rand_number_lessthan26];;
					$(keyid).val(rand_number_lessthan26_text);
					$(keyid).button('refresh');
					i++;
				}
			}
		}

		function fillKeyBoardWithWord()
		{
			var tempWord = random_word_object.word;
			var temp_key_map = {};
			for(i = 0; i < tempWord.length;)
			{
				var rand_number_lessthan12 = Math.floor(Math.random() * MAX_KEY_BOARD_INDEX + 1);
				if(!temp_key_map[rand_number_lessthan12] && rand_number_lessthan12 <= MAX_KEY_BOARD_INDEX)
				{
					var character = "" + tempWord.charAt(i);
					random_word_index_in_keyboard[i] = rand_number_lessthan12;
					var keyid = "#key_" + rand_number_lessthan12;
					temp_key_map[rand_number_lessthan12] = keyid;
					$(keyid).val(character);
					$(keyid).button('refresh');
					i++;
				}
			}
		}

		function on_key_clicked(event)
		{
			var element = event.srcElement;
			input_char = element.value;
			can_update = false;
			for(index_to_update = 0, i = 0; i < user_input_array.length; i++)
			{
				if(!user_input_array[i])
				{
					index_to_update = i;
					can_update = true;
					break;
				}
			}
			if(can_update && index_to_update <= random_word_object.word.length)
			{
				button_id = "#container_key_" + index_to_update;
				from_id = "#" + element.id;
				swap_char(from_id, button_id);
				to_key_from_key_map[button_id] = from_id;
				user_input_array[index_to_update] = true;
			}
		}

		function on_container_key_clicked(event)
		{
			var element = event.srcElement;
			var source_id = "#"+ element.id;
			delete_char = element.value;
			to_key_id = to_key_from_key_map[source_id];
			if(to_key_id)
			{
				swap_char(source_id, to_key_id);
				to_key_from_key_map[source_id] = null;
				indexDeleted = source_id.replace("#container_key_","");
				indexDeleted = parseInt(indexDeleted);
				user_input_array[indexDeleted] = false;
			}
		}

	   function on_hint_clicked(event) {
			if(MAX_HINT_ALLOWED > 0)
			{
				random_word_object.meaning.byIndexToHtml(hint_clicked, "hint_content_div");
				hint_clicked ++ ;
				MAX_HINT_ALLOWED --;
				TOTAL_POINTS -= LOOSE_HINT_POINTS;
				if(MAX_HINT_ALLOWED == 0)
				{
					$("#display_hint").button('disable');
				}
				$("#total_points").val(TOTAL_POINTS);
				$("#total_points").button('refresh');
			}
		}

		function fill_a_container_key(fromKeyID)
		{
			input_char = $(fromKeyID).val();
			can_update = false;
			for(index_to_update = 0, i = 0; i < user_input_array.length; i++)
			{
				if(!user_input_array[i])
				{
					index_to_update = i;
					can_update = true;
					break;
				}
			}
			if(can_update && index_to_update <= random_word_object.word.length)
			{
				button_id = "#container_key_" + index_to_update;
				from_id = fromKeyID;
				swap_char(from_id, button_id);
				to_key_from_key_map[button_id] = from_id;
				user_input_array[index_to_update] = true;
			}
		}

		function on_star_clicked(event)
		{
			if(MAX_REVEAL_ALLOWED > 0)
			{
				var tempWord = random_word_object.word;
				//for(i = 0; i < tempWord.length; i++)
				{
					//var i = Math.floor(Math.random() * tempWord.length + 1);
					rand_index_lessthan12 = random_word_index_in_keyboard[reveal_clicked];
					rand_index_lessthan12 = parseInt(rand_index_lessthan12);
					var source_id = "#key_" + rand_index_lessthan12;
					fill_a_container_key(source_id);
					MAX_REVEAL_ALLOWED --;
					reveal_clicked ++;
					TOTAL_POINTS -= LOOSE_REVEAL_POINTS;
					if(MAX_REVEAL_ALLOWED == 0)
					{
						$("#reveal_star").button('disable');
					}
					$("#total_points").val(TOTAL_POINTS);
					$("#total_points").button('refresh');
				}
			}
		}

		function on_delete_clicked(event)
		{
			var tempWord = random_word_object.word;
			for(i = 0; i < tempWord.length; i++)
			{
				var source_id = "#container_key_" + i;
				to_key_id = to_key_from_key_map[source_id];
				if(to_key_id)
				{
					swap_char(source_id, to_key_id);
					to_key_from_key_map[source_id] = null;
					indexDeleted = source_id.replace("#container_key_","");
					indexDeleted = parseInt(indexDeleted);
					user_input_array[indexDeleted] = false;
				}
			}
		}

		function swap_char(fromID, toID)
		{
			valTo = $(toID).val();
			valFrom = $(fromID).val();

			$(fromID).val(valTo);
			$(toID).val(valFrom);
			//$(fromID).button('enable');
			//$(toID).button('disable');
			$(fromID).button('refresh');
			$(toID).button('refresh');
			if(valTo != "*")
			{
				user_word += valTo;
			}
			else if(valFrom != "*")
			{
				user_word += valFrom;
			}
			if(user_word == random_word_object.word)
			{
				PLAYED_COUNT++;
				$("#words_played").val(PLAYED_COUNT);
				$("#words_played").button('refresh');
				alert("Word Successfully Cracked !");
			}
		}

        function setRandomWord(aWord) {
            if (typeof (Storage) !== "undefined") {
                    sessionStorage.random_word = aWord;
                }
            else {
                alert("Browser doesn't support session data ! Crome recomended");
            }
        }

		$(document).on("pageshow","#pageone",function(event){
			var heightOfWindow = $(window).height();
			var totalHeightOfButtons = $("#button_groups").height();
			var leftForHint = heightOfWindow - totalHeightOfButtons;
			$('#hint_content_div').height(leftForHint / 2);
		});

		$(document).on("pageinit","#pageone",function(event){
				$("#total_points").val(TOTAL_POINTS);
				$("#total_points").button('refresh');
				$("#words_played").val(PLAYED_COUNT);
				$("#words_played").button('refresh');
				$("#words_quited").val(QUIT_COUNT);
				$("#words_quited").button('refresh');
		});

		function getRandomWordRawData(minLength, maxLength)
		{
			var minMaxString = "&minLength=" + minLength + "&maxLength=" + maxLength;
			var queryString = "randomWord?hasDictionaryDef=true&minCorpusCount=0&maxCorpusCount=-1&minDictionaryCount=1&maxDictionaryCount=-1" + minMaxString;
			var requestURLString = BASE_API_URL + "words.json/" + queryString + API_KEY;

			$.getJSON(requestURLString,
						function(data){
							var random_word = formatRandomWord(data);
							random_word_object.word = random_word.toUpperCase();
							random_word_object.word_size = random_word.length;
							getWordDefinition(random_word);
			});
		}

		function getWordDefinition(inputWord)
		{
			var queryString = inputWord + "/definitions?limit=5&includeRelated=false&sourceDictionaries=all&useCanonical=false&includeTags=false";
			var requestURLString = BASE_API_URL + "word.json/" + queryString + API_KEY;

			$.getJSON(requestURLString,
						function(data){
					var wordDefinition = formatWordMeaning(data);
					random_word_object.meaning = wordDefinition;

					fillKeyBoard();
					fillKeyBoardWithWord();
					if(random_word_object.word.length > 2)
					{
						var max_reveal = random_word_object.word.length / 2 ;
						MAX_REVEAL_ALLOWED = parseInt(max_reveal);
						if(MAX_REVEAL_ALLOWED == 0)
						{
							$("#reveal_star").button('disable');
						}
						MAX_HINT_ALLOWED = random_word_object.meaning.zip_array.length;
						if(MAX_HINT_ALLOWED == 0)
						{
							$("#display_hint").button('disable');
						}
					}
				});
		}
    </script>
</body>
</html>
